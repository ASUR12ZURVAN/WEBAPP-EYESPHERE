<!DOCTYPE html>
<html>

<head>
    <title>Dynamic Snellen Chart</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle, #f5f7fa, #e4ebf1);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        .snellen_header{
            display: flex;
            justify-content: space-between;
        }

        .profileBtn{
            background-color: #7f1acd;
            padding: 0px 24px;
            margin: 10px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #1f4e79;
        }

        .message-box {
            background-color: #eef4fb;
            border-left: 4px solid #1f4e79;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .actions-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            background-color: #1f4e79;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #15385b;
        }

        .form-container form {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-container label {
            font-weight: 600;
        }

        .form-container input,
        .form-container select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .radio-option label {
            margin-left: 5px;
        }

        #chartContainer {
            margin: 30px 0;
        }

        .chart-line-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 12px 0;
        }

        .line-counter {
            width: 30px;
            font-weight: bold;
            margin-right: 10px;
            text-align: right;
        }

        .line {
            flex: 1;
            text-align: center;
            font-weight: 600;
            letter-spacing: 3px;
        }

        .highlight {
            color: #e74c3c;
            text-shadow: 0 0 3px rgba(231, 76, 60, 0.3);
        }

        #eyeInstruction {
            text-align: center;
        }

        #instructionText {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        #resultBox {
            background-color: #f9f9f9;
            border-left: 5px solid #2d8bd8;
            padding: 15px;
            border-radius: 6px;
            font-size: 16px;
            color: #333;
        }

        #resultBox h3 {
            color: #1f4e79;
            margin-bottom: 10px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1f4e79;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 600px) {
            .chart-line-container {
                flex-direction: column;
                gap: 5px;
            }

            .line-counter {
                margin-right: 0;
                text-align: center;
            }

            .form-container form {
                gap: 10px;
            }

            button {
                width: 100%;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            #instructionText {
                font-size: 15px;
            }
        }
    </style>

</head>

<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="snellen_header">
            <h1>Dynamic Snellen Chart</h1>
            <button class="profileBtn">Profile</button>
        </div>

        <div class="message-box">
            <strong>Vision Test Instructions:</strong> Start from the top and work your way down. Try to read up to the
            10th line for a comprehensive assessment of your vision. The 10th line is a good benchmark for normal vision
            when viewed from 3 meter distance.

        </div>

        <div class="actions-container">
            <button id="fullscreenBtn" style="display:none;">Go Fullscreen</button>
            <button id="pdfBtn" style="display:none;">Download PDF</button>
        </div>

        <div id="chartContainer"></div>

        <!-- Phase control and result display -->
        <div id="eyeInstruction" style="display: none; margin-top: 20px;">
            <p id="instructionText"></p>
            <button id="startEyeTestBtn">Start Left Eye Test</button>
        </div>

        <div id="resultBox" style="display: none; margin-top: 20px; padding: 10px; border: 1px solid #ccc;"></div>
        <!-- <div id="diopterSection" style="display: none; text-align: center; margin-top: 20px;">
            <button id="getDiopterBtn">Get Diopter</button>
            <div id="diopterOutput" style="margin-top: 15px; font-weight: bold; color: #1f4e79;"></div>
        </div> -->


        <div class="form-container">
            <form id="setupForm">
                <label for="diagonal">Screen Diagonal (inches):</label>
                <select id="diagonal" name="diagonal" required>
                    <option value="" disabled selected>Select screen size</option>
                    <option value="6.5">6.5" (Mobile)</option>
                    <option value="10.2">10.2" (Tablet)</option>
                    <option value="13.3">13.3" (Laptop)</option>
                    <option value="15.6">15.6" (Laptop)</option>
                    <option value="21.5">21.5" (Monitor)</option>
                    <option value="24">24" (Monitor)</option>
                    <option value="27">27" (Monitor)</option>
                    <option value="32">32" (TV/Monitor)</option>
                    <option value="55">55" (TV)</option>
                    <option value="65">65" (TV)</option>
                </select>
                <button type="submit">Generate Chart</button>
            </form>

            <form id="lineForm" style="display: none;" method="POST" action="{% url 'predict_diopters' %}">
                <label for="lineNumber">Line Number (1‚Äì15):</label>
                <input type="number" id="lineNumber" name="lineNumber" min="1" max="15" required>

                <div id="headacheForm">
                    <label>Are you having headache or strain while reading this?</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="headacheYes" name="headache" value="yes">
                            <label for="headacheYes">Yes</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="headacheNo" name="headache" value="no" checked>
                            <label for="headacheNo">No</label>
                        </div>
                    </div>
                </div>

                <button type="submit">Submit</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        const chartLines = [
            "E", "FP", "TOZ", "LPED", "PECFD",
            "EDFCZP", "FELOPZD", "DEFPOTEC", "LEFODPCT",
            "FDPLTCEO", "PDELOFZC", "DEFPOCTLE", "WDFTERH", "TYDLPD", "QDGTS"
        ];

        const chartContainer = document.getElementById('chartContainer');
        const setupForm = document.getElementById('setupForm');
        const lineForm = document.getElementById('lineForm');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const pdfBtn = document.getElementById('pdfBtn');
        const loading = document.getElementById('loading');
        const eyeInstruction = document.getElementById('eyeInstruction');
        const instructionText = document.getElementById('instructionText');
        const startEyeTestBtn = document.getElementById('startEyeTestBtn');
        const resultBox = document.getElementById('resultBox');

        const diopterSection = document.getElementById('diopterSection');
        const getDiopterBtn = document.getElementById('getDiopterBtn');
        const diopterOutput = document.getElementById('diopterOutput');


        let pixelSizes = [];
        let leftEyeData = null;
        let rightEyeData = null;
        let currentEye = 'left';

        function getScreenPPI(diagonal_inch) {
            const width_px = window.screen.width;
            const height_px = window.screen.height;
            const diagonal_px = Math.sqrt(width_px ** 2 + height_px ** 2);
            return diagonal_px / diagonal_inch;
        }

        function calculatePixelSizes(ppi) {
            const base_height_m = 0.00435;
            const pixelSizes = [];

            for (let i = 0; i < 12; i++) {
                const logmar = (10 - i) * 0.1;
                const height_m = base_height_m * Math.pow(10, logmar);
                const height_mm = height_m * 1000;
                const pixel_size = height_mm * (ppi / 25.4);
                pixelSizes.push(pixel_size);
            }

            return pixelSizes;
        }

        function renderChart(highlightIndex = null) {
            showLoading();
            chartContainer.innerHTML = '';

            chartLines.forEach((line, index) => {
                const container = document.createElement('div');
                container.classList.add('chart-line-container');

                const counter = document.createElement('span');
                counter.classList.add('line-counter');
                counter.textContent = `${index + 1}`;

                const div = document.createElement('div');
                div.classList.add('line');
                div.style.fontSize = pixelSizes[index] + 'px';
                div.style.textAlign = 'center';
                div.textContent = line;

                if (highlightIndex === index) div.classList.add('highlight');

                container.appendChild(counter);
                container.appendChild(div);
                chartContainer.appendChild(container);
            });

            hideLoading();
        }

        setupForm.addEventListener('submit', function (event) {
            event.preventDefault();
            showLoading();

            const diagonal_inch = parseFloat(document.getElementById('diagonal').value);
            const ppi = getScreenPPI(diagonal_inch);
            pixelSizes = calculatePixelSizes(ppi);

            renderChart();
            fullscreenBtn.style.display = 'inline-block';
            pdfBtn.style.display = 'inline-block';
            chartContainer.style.display = 'block';

            // Do NOT show form yet
            lineForm.style.display = 'none';
            resultBox.style.display = 'none';
            currentEye = 'left';

            instructionText.innerText = "Please close your LEFT eye and click below to begin the test.";
            startEyeTestBtn.innerText = "Start Left Eye Test";
            eyeInstruction.style.display = 'block';

            fullscreenBtn.textContent = 'Exit Fullscreen';
            document.documentElement.requestFullscreen().catch(() => hideLoading());

            hideLoading();
        });

        startEyeTestBtn.addEventListener('click', () => {
            lineForm.reset();
            document.getElementById('headacheNo').checked = true;
            document.getElementById('lineNumber').value = '';
            eyeInstruction.style.display = 'none';
            lineForm.style.display = 'block';
        });

        lineForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const lineNumber = parseInt(document.getElementById('lineNumber').value);
            const headache = document.querySelector('input[name="headache"]:checked').value === 'yes';

            if (currentEye === 'left') {
                leftEyeData = { lineNumber, headache };
                lineForm.style.display = 'none';
                instructionText.innerText = "Now close your RIGHT eye and click to begin the test.";
                startEyeTestBtn.innerText = "Start Right Eye Test";
                eyeInstruction.style.display = 'block';
                currentEye = 'right';
            } else {
                rightEyeData = { lineNumber, headache };
                lineForm.style.display = 'none';
                eyeInstruction.style.display = 'none';
                showResults();
            }
        });

        function showResults() {
            resultBox.innerHTML = `
        <h3>Vision Test Results:</h3>
        <p><strong>üëÅÔ∏è Left Eye:</strong><br>
        Line Number: ${leftEyeData.lineNumber}<br>
        Headache: ${leftEyeData.headache ? "Yes" : "No"}</p>

        <p><strong>üëÅÔ∏è Right Eye:</strong><br>
        Line Number: ${rightEyeData.lineNumber}<br>
        Headache: ${rightEyeData.headache ? "Yes" : "No"}</p>
    `;

            resultBox.style.display = 'block';
            diopterSection.style.display = 'block'; // üî• show button
            currentEye = 'left';
        }


        function showLoading() {
            loading.style.display = 'flex';
        }

        function hideLoading() {
            setTimeout(() => {
                loading.style.display = 'none';
            }, 300);
        }

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
        }

        // getDiopterBtn.addEventListener('click', () => {
        //     // Example calculation: average of line numbers mapped to basic diopter range
        //     const averageLine = (leftEyeData.lineNumber + rightEyeData.lineNumber) / 2;
        //     let diopter;

        //     if (averageLine >= 10) diopter = '0 to -0.5 (Normal)';
        //     else if (averageLine >= 7) diopter = '-0.5 to -1.5 (Mild)';
        //     else if (averageLine >= 4) diopter = '-1.5 to -2.5 (Moderate)';
        //     else diopter = '-2.5 or worse (Severe)';

        //     diopterOutput.textContent = `Estimated Diopter: ${diopter}`;
        // });

    </script>
</body>



</html>