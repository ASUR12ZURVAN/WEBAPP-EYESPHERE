<!DOCTYPE html>
<html>
<head>
    <title>Dynamic Snellen Chart</title>
    <style>
        body {
            text-align: center;
            font-family: monospace, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fff;
        }
        .line {
            margin: 10px 0;
            letter-spacing: 10px;
        }
        .highlight {
            color: red;
            font-weight: bold;
            animation: flash 1s infinite;
        }
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.2; }
            100% { opacity: 1; }
        }
        #fullscreenBtn, #pdfBtn {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>

    <h1>Dynamic Snellen Chart</h1>

    <form id="setupForm">
        <label for="diagonal">Enter Screen Diagonal (in inches): </label>
        <input type="number" id="diagonal" name="diagonal" step="0.1" required>
        <button type="submit">Generate Chart</button>
    </form>

    <form id="lineForm" style="display:none; margin-top: 20px;">
        <label for="lineNumber">Enter Line Number (1-15): </label>
        <input type="number" id="lineNumber" name="lineNumber" min="1" max="15" required>
        <button type="submit">Highlight</button>
    </form>

    <button id="fullscreenBtn" style="display:none;">
        Go Fullscreen
    </button>
    <button id="pdfBtn" style="display:none;">
        Download PDF
    </button>

    <div id="chartContainer" style="margin-top: 30px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        const chartLines = [
            "E", "FP", "TOZ", "LPED", "PECFD",
            "EDFCZP", "FELOPZD", "DEFPOTEC", "LEFODPCT",
            "FDPLTCEO", "PDELOFZC", "DEFPOCTLE",
            "FELPZOTEC", "PDEZCFLOP", "LEPCTDFOZ"
        ];

        const width_px = window.screen.width;
        const height_px = window.screen.height;

        function getScreenPPI(diagonal_inch) {
            const diagonal_px = Math.sqrt(width_px ** 2 + height_px ** 2);
            return diagonal_px / diagonal_inch;
        }

        function calculatePixelSizes(ppi) {
            const distance_m = 3.0;
            const base_height_m = 0.00435;

            const pixelSizes = [];

            for (let i = 0; i < 15; i++) {
                const logmar = (10 - i) * 0.1;
                const height_m = base_height_m * Math.pow(10, logmar);
                const height_mm = height_m * 1000;
                const pixel_size = height_mm * (ppi / 25.4);
                pixelSizes.push(pixel_size);
                console.log(`Line ${i + 1} (logMAR ${logmar.toFixed(1)}): ${pixel_size.toFixed(2)} px`);
            }

            return pixelSizes;
        }

        const chartContainer = document.getElementById('chartContainer');
        const setupForm = document.getElementById('setupForm');
        const lineForm = document.getElementById('lineForm');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const pdfBtn = document.getElementById('pdfBtn');

        let pixelSizes = [];

        function renderChart(highlightIndex = null) {
            chartContainer.innerHTML = '';
            chartLines.forEach((line, index) => {
                const div = document.createElement('div');
                div.classList.add('line');
                if (highlightIndex === index) {
                    div.classList.add('highlight');
                }
                div.style.fontSize = pixelSizes[index] + 'px';
                div.textContent = line;
                chartContainer.appendChild(div);
            });
        }

        fullscreenBtn.addEventListener('click', function() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
                fullscreenBtn.textContent = 'Go Fullscreen';
            } else {
                document.documentElement.requestFullscreen().catch((err) => {
                    console.warn(`Failed to enter fullscreen: ${err.message}`);
                });
                fullscreenBtn.textContent = 'Exit Fullscreen';
            }
        });

        pdfBtn.addEventListener('click', function() {
            const opt = {
                margin:       0,
                filename:     'snellen_chart.pdf',
                image:        { type: 'jpeg', quality: 1 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(chartContainer).save();
        });

        setupForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const diagonal_inch = parseFloat(document.getElementById('diagonal').value);
            const ppi = getScreenPPI(diagonal_inch);
            pixelSizes = calculatePixelSizes(ppi);

            console.log("Calculated PPI:", ppi);
            console.log("Pixel Sizes:", pixelSizes);

            lineForm.style.display = 'block';
            fullscreenBtn.style.display = 'inline-block';
            pdfBtn.style.display = 'inline-block';
            renderChart();

            document.documentElement.requestFullscreen().catch((err) => {
                console.warn(`Failed to enter fullscreen: ${err.message}`);
            });
            fullscreenBtn.textContent = 'Exit Fullscreen';
        });

        lineForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const lineNumber = parseInt(document.getElementById('lineNumber').value, 10);
            if (lineNumber >= 1 && lineNumber <= 15) {
                renderChart(lineNumber - 1);
            } else {
                alert('Please enter a valid line number (1â€“15).');
            }
        });
    </script>

</body>
</html>
