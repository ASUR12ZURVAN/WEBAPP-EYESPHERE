<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peripheral Number Memory Test</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3bc47d;
            --accent-color: #ff6b6b;
            --dark-color: #1e2a3a;
            --light-color: #f8fafc;
            --neutral-color: #a0aec0;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            height: 100vh;
            color: var(--light-color);
        }
        
        /* Stars background */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            opacity: 0.3;
            animation: twinkle 4s infinite;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.3; }
            50% { opacity: 0.8; }
            100% { opacity: 0.3; }
        }
        
        /* Start Screen Styles */
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .start-container {
            background-color: rgba(30, 42, 58, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideInStart 0.8s ease-out;
        }
        
        @keyframes slideInStart {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .start-container h1 {
            font-size: 32px;
            color: var(--light-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .instructions {
            text-align: left;
            margin: 25px 0;
            font-size: 16px;
            line-height: 1.6;
            color: var(--light-color);
        }
        
        .instructions h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 20px;
            text-align: center;
        }
        
        .instructions ul {
            list-style: none;
            padding: 0;
        }
        
        .instructions li {
            margin: 12px 0;
            padding-left: 30px;
            position: relative;
        }
        
        .instructions li::before {
            content: 'üëÅÔ∏è';
            position: absolute;
            left: 0;
            top: 0;
        }
        
        .instructions li:nth-child(2)::before { content: 'üî¢'; }
        .instructions li:nth-child(3)::before { content: '‚úçÔ∏è'; }
        .instructions li:nth-child(4)::before { content: 'üìà'; }
        .instructions li:nth-child(5)::before { content: 'üéØ'; }
        .instructions li:nth-child(6)::before { content: '‚öïÔ∏è'; }
        
        .screen-distance-setup {
            background-color: rgba(67, 97, 238, 0.1);
            border: 1px solid rgba(67, 97, 238, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .screen-distance-setup h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .distance-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .distance-input input {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--light-color);
            font-size: 16px;
            width: 80px;
            text-align: center;
        }
        
        .distance-input label {
            color: var(--light-color);
            font-size: 14px;
        }
        
        #startGameBtn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 18px 36px;
            font-size: 20px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            margin-top: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 25px auto 0;
        }
        
        #startGameBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(67, 97, 238, 0.4);
            background: linear-gradient(135deg, #3051d3, #2eae6d);
        }
        
        #startGameBtn:active {
            transform: translateY(0);
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 10;
            padding: 15px;
            background-color: rgba(30, 42, 58, 0.7);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h1 {
            font-size: 28px;
            color: var(--light-color);
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }
        
        .header p {
            font-size: 16px;
            color: var(--neutral-color);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .game-area {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #centerArea {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #centerDot {
            position: relative;
            width: 24px;
            height: 24px;
            background-color: var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.7);
            animation: pulse 2s infinite;
            z-index: 5;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            70% {
                transform: scale(1.2);
                box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }
        
        #focusText {
            position: relative;
            margin-top: 35px;
            font-size: 18px;
            font-weight: 500;
            color: var(--light-color);
            background-color: rgba(30, 42, 58, 0.7);
            padding: 8px 18px;
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .number {
            position: absolute;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            animation: fadeInNumber 0.4s forwards ease-out;
            z-index: 3;
        }
        
        @keyframes fadeInNumber {
            from { opacity: 0; transform: scale(0.5); filter: blur(5px); }
            to { opacity: 1; transform: scale(1); filter: blur(0); }
        }
        
        #inputSection {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            background-color: rgba(30, 42, 58, 0.8);
            backdrop-filter: blur(10px);
            padding: 25px 35px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            max-width: 90%;
            width: 450px;
            display: none;
            animation: slideUp 0.6s forwards;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 80px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        #levelText {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
            position: relative;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        #levelText::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
        }
        
        #inputSection p {
            margin: 12px 0;
            font-size: 16px;
            color: var(--light-color);
        }
        
        .input-container {
            position: relative;
            margin: 15px 0;
        }
        
        #userInput {
            width: 100%;
            padding: 14px 15px;
            font-size: 18px;
            border: 2px solid rgba(160, 174, 192, 0.3);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--light-color);
            transition: var(--transition);
            outline: none;
        }
        
        #userInput:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.3);
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        #userInput::placeholder {
            color: rgba(160, 174, 192, 0.7);
        }
        
        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
            opacity: 0;
            transition: var(--transition);
        }
        
        button:hover::before {
            opacity: 1;
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: var(--shadow-sm);
        }
        
        #checkBtn {
            background-color: var(--primary-color);
            color: white;
            flex: 1;
        }
        
        #checkBtn:hover {
            background-color: #3051d3;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        #restartBtn {
            background-color: var(--secondary-color);
            color: white;
            flex: 1;
        }
        
        #restartBtn:hover {
            background-color: #2eae6d;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        #viewResultsBtn {
            background-color: var(--accent-color);
            color: white;
            flex: 1;
            display: none;
        }
        
        #viewResultsBtn:hover {
            background-color: #e55555;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        #score {
            margin-top: 20px;
            font-size: 18px;
            font-weight: 500;
            padding: 12px;
            border-radius: 8px;
            transition: var(--transition);
            opacity: 0;
        }
        
        .score-highlight {
            background-color: rgba(59, 196, 125, 0.15);
            animation: highlight 1.5s ease-in-out forwards;
            opacity: 1 !important;
        }
        
        @keyframes highlight {
            0% { background-color: rgba(59, 196, 125, 0); }
            30% { background-color: rgba(59, 196, 125, 0.25); }
            100% { background-color: rgba(59, 196, 125, 0.15); }
        }
        
        /* Level indicator */
        .level-indicator {
            position: absolute;
            top: 90px;
            right: 20px;
            background-color: rgba(30, 42, 58, 0.8);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: var(--shadow-md);
            font-weight: 600;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            z-index: 10;
        }
        
        .level-indicator i {
            color: var(--primary-color);
        }
        
        #levelDisplay {
            font-size: 18px;
            font-weight: 700;
            color: var(--light-color);
        }
        
        /* Stats section */
        .stats-container {
            position: absolute;
            top: 90px;
            left: 20px;
            background-color: rgba(30, 42, 58, 0.8);
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 160px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-label {
            color: var(--neutral-color);
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--light-color);
        }
        
        /* Progress indicator */
        .progress-bar {
            position: absolute;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.5s ease;
        }
        
        /* Help button */
        .help-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(30, 42, 58, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--neutral-color);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            z-index: 10;
            backdrop-filter: blur(8px);
        }
        
        .help-btn:hover {
            color: var(--light-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .start-container {
                padding: 30px 20px;
                margin: 20px;
            }
            
            .start-container h1 {
                font-size: 24px;
            }
            
            .instructions {
                font-size: 14px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            #inputSection {
                width: 90%;
                padding: 20px;
            }
            
            button {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .stats-container {
                top: auto;
                left: 20px;
                bottom: 90px;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 15px;
                justify-content: space-around;
                min-width: 0;
                width: calc(100% - 40px);
            }
            
            .stat-item {
                width: 45%;
            }
            
            .level-indicator {
                top: auto;
                bottom: 150px;
                right: 20px;
            }
            
            .progress-bar {
                top: auto;
                bottom: 20px;
                width: calc(100% - 40px);
            }
        }
    </style>
</head>


<body>
    <!-- Stars background -->
    <div class="stars" id="stars"></div>
    
    <!-- Start Screen -->
    <div id="startScreen">
        <div class="start-container">
            <h1>üéØ Peripheral Vision Memory Test</h1>
            <div class="instructions">
                <h3>How to Play:</h3>
                <ul>
                    <li>Keep your eyes focused on the red dot in the center at all times</li>
                    <li>Numbers will appear at calculated visual angles based on medical standards</li>
                    <li>After all numbers are shown, enter what you remembered (separated by commas)</li>
                    <li>Complete 3 levels testing different visual field ranges</li>
                    <li>Test results correlate with clinical visual field defect classifications</li>
                    <li>Maintain consistent viewing distance for accurate results</li>
                </ul>
            </div>
            
            <div class="screen-distance-setup">
                <h4>üìè Setup Instructions</h4>
                <p>For accurate visual angle calculations, please:</p>
                <div class="distance-input">
                    <label for="viewingDistance">Viewing Distance:</label>
                    <input type="number" id="viewingDistance" value="60" min="30" max="120">
                    <span>cm</span>
                </div>
                <p style="font-size: 14px; margin-top: 10px; color: var(--neutral-color);">
                    Sit approximately 60cm (arm's length) from your screen for optimal results.
                </p>
            </div>
            
            <button id="startGameBtn">
                <i class="fas fa-play"></i>
                Start Test
            </button>
        </div>
    </div>
    
    <div id="gameContainer" style="display: none;">
        <!-- UI Elements that should be hidden during gameplay -->
        <div id="gameUI">
            <div class="header">
                <h1>Peripheral Vision Memory Test</h1>
                <p>Keep your eyes on the center dot and try to remember the numbers that appear</p>
            </div>
            
            <div class="level-indicator">
                <i class="fas fa-layer-group"></i> Level <span id="levelDisplay">1</span>
            </div>
            
            <div class="stats-container">
                <div class="stat-item">
                    <span class="stat-label">Field Range:</span>
                    <span class="stat-value" id="fieldRange">0-10¬∞</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Current Level:</span>
                    <span class="stat-value" id="currentLevelStat">1 / 3</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Progress:</span>
                    <span class="stat-value" id="progressStat">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Distance:</span>
                    <span class="stat-value" id="distanceDisplay">60cm</span>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <!-- Game area - always visible during game -->
        <div class="game-area" id="gameArea">
            <div id="centerArea">
                <div id="focusRing"></div>
                <div id="centerDot"></div>
                <div id="focusText">Focus on this dot</div>
            </div>
            <!-- Numbers will be positioned within this container -->
            <div id="numbersContainer"></div>
        </div>
        
        <input type="hidden" id="user-id" value="{{ user.id }}">

        <!-- Input section - hidden during gameplay -->
        <div id="inputSection" style="display: none;">
            <p id="levelText">Level 1</p>
            <p>Enter the numbers you saw (separated by commas):</p>
            <div class="input-container">
                <input type="text" id="userInput" placeholder="e.g., 5,6,7" autocomplete="off">
            </div>
            <div class="buttons-container">
                <button id="checkBtn"><i class="fas fa-check"></i> Check</button>
                <button id="restartBtn"><i class="fas fa-sync-alt"></i> Restart</button>
                <button id="viewResultsBtn"><i class="fas fa-history"></i> Go to Profile</button>
            </div>
            <div id="score"></div>
            <div id="post-submit-actions" style="display: none;"></div>
        </div>
        
        <button class="help-btn" id="helpBtn" style="display: none;"><i class="fas fa-question"></i></button>
    </div>

    <script>
        const colors = ['#ff6b6b', '#4cc9f0', '#4361ee', '#3bc47d', '#f72585'];
        const displayTime = 1500; // ms per number
        const numberCount = 5;
        let generatedNumbers = [];
        let currentLevel = 1;
        let totalScore = 0;
        let correctAnswers = 0;
        let gameStarted = false;
        let viewingDistanceCm = 60;
        let pixelsPerCm = 0;
        let isDisplayingNumbers = false;
        
        const levelRanges = {
            1: { min: 5, max: 10, description: "0-10¬∞ (Central)" },
            2: { min: 10, max: 20, description: "10-20¬∞ (Paracentral)" },
            3: { min: 20, max: 30, description: "20-30¬∞ (Peripheral)" }
        };
        
        // Hide UI elements during number display
        function hideUIForGameplay() {
            document.getElementById('gameUI').style.display = 'none';
            document.getElementById('helpBtn').style.display = 'none';
            document.getElementById('inputSection').style.display = 'none';
            isDisplayingNumbers = true;
        }
        
        // Show UI elements after number display
        function showUIAfterGameplay() {
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('helpBtn').style.display = 'block';
            isDisplayingNumbers = false;
        }
        
        function calculatePixelsPerCm() {
            const screenWidthPx = window.screen.width;
            const screenHeightPx = window.screen.height;
            const screenDiagonalInches = 15;
            const aspectRatio = screenWidthPx / screenHeightPx;
            
            const screenWidthInches = screenDiagonalInches * aspectRatio / Math.sqrt(aspectRatio * aspectRatio + 1);
            const screenHeightInches = screenDiagonalInches / Math.sqrt(aspectRatio * aspectRatio + 1);
            
            const screenWidthCm = screenWidthInches * 2.54;
            const screenHeightCm = screenHeightInches * 2.54;
            
            const pixelsPerCmWidth = screenWidthPx / screenWidthCm;
            const pixelsPerCmHeight = screenHeightPx / screenHeightCm;
            
            return (pixelsPerCmWidth + pixelsPerCmHeight) / 2;
        }
        
        function visualAngleToPixels(angleDegrees, distanceCm) {
            const angleRadians = angleDegrees * (Math.PI / 180);
            const physicalDistanceCm = Math.tan(angleRadians) * distanceCm;
            return physicalDistanceCm * pixelsPerCm;
        }
        
        function calculateVisualAngle(pixelX, pixelY, centerX, centerY, distanceCm) {
            const deltaX = pixelX - centerX;
            const deltaY = pixelY - centerY;
            const deltaXCm = deltaX / pixelsPerCm;
            const deltaYCm = deltaY / pixelsPerCm;
            const radialDistanceCm = Math.sqrt(deltaXCm * deltaXCm + deltaYCm * deltaYCm);
            const angleRadians = Math.atan(radialDistanceCm / distanceCm);
            const angleDegrees = angleRadians * (180 / Math.PI);
            return angleDegrees;
        }
        
        function generatePositionAtAngle(targetAngleDegrees) {
            const gameArea = document.getElementById('gameArea');
            const gameRect = gameArea.getBoundingClientRect();
            const centerX = gameRect.width / 2;
            const centerY = gameRect.height / 2;
            const targetPixelDistance = visualAngleToPixels(targetAngleDegrees, viewingDistanceCm);
            const circularAngle = Math.random() * 2 * Math.PI;
            
            const x = centerX + Math.cos(circularAngle) * targetPixelDistance;
            const y = centerY + Math.sin(circularAngle) * targetPixelDistance;
            
            const margin = 50;
            const clampedX = Math.max(margin, Math.min(gameRect.width - margin, x));
            const clampedY = Math.max(margin, Math.min(gameRect.height - margin, y));
            
            const actualAngle = calculateVisualAngle(clampedX, clampedY, centerX, centerY, viewingDistanceCm);
            
            return { x: clampedX, y: clampedY, actualAngle: actualAngle };
        }
        
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const numberOfStars = 100;
            
            for (let i = 0; i < numberOfStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 4 + 's';
                starsContainer.appendChild(star);
            }
        }
        
        function initializeDisplayCalculations() {
            pixelsPerCm = calculatePixelsPerCm();
            console.log(`Calculated pixels per cm: ${pixelsPerCm.toFixed(2)}`);
        }
        
        function generateNumbers() {
            generatedNumbers = [];
            const range = levelRanges[currentLevel];
            
            for (let i = 0; i < numberCount; i++) {
                const targetAngle = Math.random() * (range.max - range.min) + range.min;
                const position = generatePositionAtAngle(targetAngle);
                
                generatedNumbers.push({
                    value: Math.floor(Math.random() * 9) + 1,
                    x: position.x,
                    y: position.y,
                    angle: position.actualAngle
                });
            }
            
            console.log(`Level ${currentLevel} numbers:`, generatedNumbers.map(n => `${n.value} at ${n.angle.toFixed(1)}¬∞`));
        }
        
        async function displayNumbers() {
            // Hide UI elements during number display
            hideUIForGameplay();
            
            const numbersContainer = document.getElementById('numbersContainer');
            
            for (let i = 0; i < generatedNumbers.length; i++) {
                const numberData = generatedNumbers[i];
                const numberElement = document.createElement('div');
                numberElement.className = 'number';
                numberElement.textContent = numberData.value;
                
                numberElement.style.position = 'absolute';
                numberElement.style.left = numberData.x + 'px';
                numberElement.style.top = numberData.y + 'px';
                numberElement.style.fontSize = '40px';
                numberElement.style.color = colors[i % colors.length];
                numberElement.style.fontWeight = 'bold';
                numberElement.style.pointerEvents = 'none';
                numberElement.style.zIndex = '100';
                
                numbersContainer.appendChild(numberElement);
                
                // Update progress (but don't show it during display)
                const progress = ((i + 1) / numberCount) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressStat').textContent = Math.round(progress) + '%';
                
                await new Promise(resolve => setTimeout(resolve, displayTime));
                numberElement.remove();
            }
            
            // Show UI elements after number display
            showUIAfterGameplay();
            
            // Show input section
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('userInput').focus();
        }
        
        function checkAnswer() {
            const userInput = document.getElementById('userInput').value.trim();
            const userNumbers = userInput.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            const correctNumbers = generatedNumbers.map(n => n.value);
            
            let correct = 0;
            let total = correctNumbers.length;
            
            for (let num of userNumbers) {
                if (correctNumbers.includes(num)) {
                    correct++;
                    const index = correctNumbers.indexOf(num);
                    correctNumbers.splice(index, 1);
                }
            }
            
            const levelScore = Math.round((correct / total) * 100);
            totalScore += levelScore;
            correctAnswers += correct;
            
            const scoreElement = document.getElementById('score');
            const range = levelRanges[currentLevel];
            scoreElement.innerHTML = `
                <strong>Level ${currentLevel} Results:</strong><br>
                Field Range: ${range.description}<br>
                Correct: ${correct}/${total} (${levelScore}%)<br>
                Your input: [${userInput}]<br>
                Correct sequence: [${generatedNumbers.map(n => n.value).join(', ')}]
            `;
            scoreElement.classList.add('score-highlight');
            
            updateLevelStats();
            
            setTimeout(() => {
                if (currentLevel < 3) {
                    nextLevel();
                } else {
                    showFinalResults();
                }
            }, 3000);
        }
        
        function updateLevelStats() {
            const range = levelRanges[currentLevel];
            document.getElementById('fieldRange').textContent = range.description.split(' ')[0];
            document.getElementById('currentLevelStat').textContent = `${currentLevel} / 3`;
            document.getElementById('levelDisplay').textContent = currentLevel;
        }
        
        function nextLevel() {
            currentLevel++;
            document.getElementById('levelText').textContent = `Level ${currentLevel}`;
            document.getElementById('userInput').value = '';
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('score').classList.remove('score-highlight');
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressStat').textContent = '0%';
            
            updateLevelStats();
            
            setTimeout(() => {
                generateNumbers();
                displayNumbers();
            }, 1000);
        }
        
        function showFinalResults() {
            const averageScore = Math.round(totalScore / 3);
            const totalCorrect = correctAnswers;
            const totalPossible = 15;
            
            let severity = "Normal";
            let recommendation = "Your peripheral vision appears to be functioning normally.";
            
            if (averageScore < 30) {
                severity = "Severe Defect";
                recommendation = "Consider consulting an eye care professional for a comprehensive visual field examination.";
            } else if (averageScore < 60) {
                severity = "Moderate Defect";
                recommendation = "Some peripheral vision limitations detected. Professional evaluation recommended.";
            } else if (averageScore < 90) {
                severity = "Mild Defect";
                recommendation = "Minor peripheral vision limitations. Monitor and consider professional evaluation.";
            }
            
            const scoreElement = document.getElementById('score');
            scoreElement.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">üéØ Test Complete!</h3>
                    <div style="margin: 15px 0;">
                        <strong>Overall Performance:</strong><br>
                        ${totalCorrect}/${totalPossible} correct (${averageScore}%)
                    </div>
                    <div style="margin: 15px 0;">
                        <strong>Assessment:</strong> ${severity}<br>
                        <em style="font-size: 14px; color: var(--neutral-color);">${recommendation}</em>
                    </div>
                    <div style="font-size: 12px; color: var(--neutral-color); margin-top: 15px;">
                        <strong>Disclaimer:</strong> This is a screening tool, not a diagnostic test. 
                        Consult a qualified eye care professional for medical advice.
                    </div>
                </div>
            `;
            
            document.getElementById('viewResultsBtn').style.display = 'block';
            document.getElementById('checkBtn').style.display = 'none';
        }
        
        function restartGame() {
            currentLevel = 1;
            totalScore = 0;
            correctAnswers = 0;
            generatedNumbers = [];
            
            document.getElementById('levelText').textContent = 'Level 1';
            document.getElementById('userInput').value = '';
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('score').classList.remove('score-highlight');
            document.getElementById('score').innerHTML = '';
            document.getElementById('checkBtn').style.display = 'block';
            document.getElementById('viewResultsBtn').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressStat').textContent = '0%';
            
            updateLevelStats();
            
            setTimeout(() => {
                generateNumbers();
                displayNumbers();
            }, 1000);
        }
        
        function startGame() {
            viewingDistanceCm = parseInt(document.getElementById('viewingDistance').value) || 60;
            document.getElementById('distanceDisplay').textContent = viewingDistanceCm + 'cm';
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            gameStarted = true;
            
            initializeDisplayCalculations();
            updateLevelStats();
            
            setTimeout(() => {
                generateNumbers();
                displayNumbers();
            }, 1000);
        }
        
        function showHelp() {
            alert(`Peripheral Vision Memory Test Help:

1. Keep your eyes focused on the red center dot at all times
2. Numbers will appear at specific visual angles around your peripheral vision
3. Try to remember the numbers without looking directly at them
4. Enter the numbers you remember separated by commas
5. Complete all 3 levels to get your assessment

Visual Field Ranges:
‚Ä¢ Level 1: 0-10¬∞ (Central vision)
‚Ä¢ Level 2: 10-20¬∞ (Paracentral vision)  
‚Ä¢ Level 3: 20-30¬∞ (Peripheral vision)

Tip: Maintain consistent viewing distance for accurate results!`);
        }
        
        // Event listeners
        document.getElementById('startGameBtn').addEventListener('click', startGame);
        document.getElementById('checkBtn').addEventListener('click', checkAnswer);
        document.getElementById('restartBtn').addEventListener('click', restartGame);
        document.getElementById('helpBtn').addEventListener('click', showHelp);
        document.getElementById('viewResultsBtn').addEventListener('click', () => {
            alert('Results saved! In a full application, this would redirect to your profile page.');
        });
        
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
        
        window.addEventListener('load', function() {
            createStars();
            initializeDisplayCalculations();
        });
        
        window.addEventListener('resize', function() {
            initializeDisplayCalculations();
        });
        
        function submitResultsToBackend() {
            const resultData = {
                total_score: totalScore,
                correct_answers: correctAnswers,
                total_possible: 15,
                average_score: Math.round(totalScore / 3),
                severity: severity,
                viewing_distance: viewingDistanceCm,
                level_scores: []
            };

            fetch('/submit-peripheral-test-result/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(resultData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Results saved successfully');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>