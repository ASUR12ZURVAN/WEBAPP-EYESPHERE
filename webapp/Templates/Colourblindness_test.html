<!-- {% load static %} -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Color Blindness Test</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --primary-lightest: #eff6ff;
            --primary-pale: #93c5fd;
            --secondary: #8b5cf6;
            --success: #059669;
            --error: #dc2626;
            --warning: #d97706;
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --backdrop-blur: blur(8px);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: white;
            min-height: 100vh;
            color: var(--neutral-800);
            line-height: 1.6;
            font-feature-settings: 'kern' 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Glass morphism background overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="white" opacity="0.1"/><circle cx="80" cy="40" r="0.5" fill="white" opacity="0.1"/><circle cx="40" cy="80" r="1.5" fill="white" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>'); */
            pointer-events: none;
            z-index: 0;
        }

        main {
            position: relative;
            z-index: 1;
            max-width: min(95vw, 56rem);
            margin: clamp(1rem, 4vw, 3rem) auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            overflow: hidden;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(2rem);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header gradient */
        main::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 0.5rem;

            /* background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary)); */
            background-size: 200% 100%;
            animation: gradientShift 4s ease-in-out infinite;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }


        .navbar {
            background-color: #f6f6f6;
            color: #05394d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            min-height: 60px;
            z-index: 10;
        }

        /* Logo Styling */
        .navbar .logo img {
            height: 80px;
            /* Adjust as needed for your logo size */
            vertical-align: middle;
            /* Align image nicely with text if any */
        }

        /* Navigation Links Styling */
        .navbar .nav-links {
            display: flex;
            /* Display links in a row */
            list-style: none;
            /* Remove bullet points if it were a ul */
            margin: 0;
            padding: 0;
        }

        .navbar .nav-links a {
            color: #05394d;
            text-decoration: none;
            font-weight: 600;
            /* Remove underline from links */
            padding: 10px 15px;
            /* Padding around each link */
            transition: background-color 0.3s ease, color 0.3s ease;
            /* Smooth transition on hover */
            border-radius: 5px;
            /* Slightly rounded corners for links */
        }

        .navbar .nav-links a:hover,
        .navbar .nav-links a.active {
            /* Add an 'active' class for the current page */
            background-color: #f6f7f5;
            /* Slightly lighter background on hover/active */
            color: #0a9ec6;
        }

        /* Hamburger Icon Styling (for mobile) */
        .hamburger {
            display: none;
            /* Hidden by default on larger screens */
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 25px;
            cursor: pointer;
            z-index: 1000;
            /* Ensure it's above other content */
        }

        .hamburger .bar {
            width: 100%;
            height: 3px;
            background-color: rgb(0, 0, 0);
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
            /* Smooth transition for hamburger animation */
        }

        /* JavaScript will add a 'open' class to .hamburger and .nav-links when clicked */
        .hamburger.open .bar:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }

        .hamburger.open .bar:nth-child(2) {
            opacity: 0;
            /* Hide the middle bar */
        }

        .hamburger.open .bar:nth-child(3) {
            transform: translateY(-11px) rotate(-45deg);
        }


        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {

            /* Adjust breakpoint as needed */
            .navbar {
                flex-wrap: wrap;
                /* Allow items to wrap to the next line */
            }

            .navbar .logo {
                flex-grow: 1;
                /* Allow logo to take available space */
            }

            .navbar .nav-links {
                display: none;
                /* Hide navigation links by default on small screens */
                flex-direction: column;
                /* Stack links vertically */
                width: 100%;
                /* Take full width */
                color: #05394d;
                background-color: #ffffff;
                /* Slightly different background for the dropdown */
                position: absolute;
                top: 60px;
                /* Position below the navbar (adjust if navbar height changes) */
                left: 0;
                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
                transition: all 0.3s ease-in-out;
                /* Smooth slide-down animation */
                overflow: hidden;
                /* Hide overflow content during transition */
                max-height: 0;
                /* Initially collapsed */
            }

            .navbar .nav-links.open {
                display: flex;
                /* Show links when the 'open' class is added */
                max-height: 300px;
                /* A value larger than the actual height to allow smooth transition */
            }

            .navbar .nav-links a {
                padding: 15px 20px;
                /* More padding for easier tapping */
                text-align: center;
                /* Center align links */
                border-bottom: 1px solid #555;
                /* Separator between links */
            }

            .navbar .nav-links a:last-child {
                border-bottom: none;
                /* No border for the last link */
            }

            .hamburger {
                display: flex;
                /* Show hamburger icon on small screens */
            }
        }

        /* Optional: Even smaller screens adjustments */
        @media (max-width: 480px) {
            .navbar {
                padding: 8px 15px;
            }

            .navbar .logo img {
                height: 35px;
            }
        }


        .content-wrapper {
            /* height: 400px; */
            color: white;
            padding: clamp(1.5rem, 4vw, 3rem);
            z-index: -1
        }

        h1 {
            text-align: center;
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 1rem;
            background: rgb(224, 224, 237);
            /* background: linear-gradient(135deg, var(--primary), var(--secondary)); */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
        }

        h2 {
            color: var(--primary);
            font-size: clamp(1.5rem, 3vw, 2rem);
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        h3 {
            color: var(--primary);
            font-size: clamp(1.125rem, 2.5vw, 1.375rem);
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-light);
            position: relative;
        }

        h3::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 3rem;
            height: 2px;
            /* background: var(--primary); */
            border-radius: 1px;
        }

        .instructions {
            font-size: clamp(1rem, 2.5vw, 1.125rem);
            line-height: 1.7;
            text-align: center;
            margin-bottom: 2rem;
            color: rgb(212, 205, 205);
            max-width: 42rem;
            margin-left: auto;
            margin-right: auto;
        }

        .hidden {
            display: none !important;
        }

        /* Enhanced button styles */
        button {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: #082733;
            color: white;
            font-weight: 500;
            border: none;
            border-radius: var(--radius-lg);
            padding: clamp(0.625rem, 2vw, 0.875rem) clamp(1.25rem, 4vw, 2rem);
            cursor: pointer;
            font-size: clamp(0.875rem, 2vw, 1rem);
            font-family: inherit;
            transition: var(--transition);
            user-select: none;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        #start-test {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            padding: clamp(0.875rem, 2.5vw, 1.125rem) clamp(2rem, 5vw, 3rem);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            background: #093647;
            /* background: linear-gradient(135deg, var(--primary), var(--secondary)); */
            transform: scale(1);
            transition: var(--transition-slow);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        button:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
            transition-duration: 0.1s;
        }

        button:disabled {
            background: var(--neutral-300);
            color: var(--neutral-500);
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-sm);
        }

        /* Test container improvements */
        #test-container {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            min-height: 60vh;
            justify-content: space-between;
            gap: 33px;
            /* Distribute space between content and navigation/progress */
        }

        .plates-wrapper {
            /* Removed flex: 1; */
            flex-grow: 1;
            /* Allow it to grow, but the navigation/progress will remain at the bottom due to flex-direction: column and order */
            margin-bottom: 2rem;
            display: flex;
            /* Make it a flex container to center its content */
            justify-content: center;
            /* Center horizontally */
            align-items: center;
            /* Center vertically */
        }

        .test-plate {
            display: none;
            background: var(--neutral-50);
            border-radius: var(--radius-xl);
            padding: clamp(1.25rem, 3vw, 2rem);
            border: 1px solid var(--neutral-200);
            transition: var(--transition-slow);
            width: 100%;
            /* Ensure it takes full width within plates-wrapper */
        }

        .test-plate.active {
            display: block;
            animation: plateSlide 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes plateSlide {
            from {
                opacity: 0;
                transform: translateX(1rem);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .plate-image-placeholder {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            padding: clamp(1rem, 3vw, 1.5rem);
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
        }

        .plate-image {
            border-radius: var(--radius-lg);
            max-width: min(100%, 20rem);
            height: auto;
            transition: var(--transition-slow);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .plate-image:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.15));
        }

        .input-container {
            background: white;
            padding: clamp(1rem, 3vw, 1.5rem);
            border-radius: var(--radius-xl);
            border: 1px solid var(--neutral-200);
            box-shadow: var(--shadow-sm);
        }

        .input-container label {
            font-weight: 500;
            margin-bottom: 0.75rem;
            color: var(--neutral-700);
            display: block;
            font-size: clamp(0.875rem, 2vw, 1rem);
        }

        .input-container input[type="number"],
        .input-container select {
            width: 100%;
            font-size: clamp(1rem, 2.5vw, 1.125rem);
            padding: clamp(0.75rem, 2vw, 1rem);
            border-radius: var(--radius-lg);
            border: 2px solid var(--neutral-300);
            outline: none;
            transition: var(--transition);
            font-family: inherit;
            background: rgb(208, 204, 204);
        }

        .input-container input[type="number"]:focus,
        .input-container select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background: white;
        }

        /* Navigation improvements - Fixed positioning */
        .navigation {
            display: flex;
            justify-content: center;
            gap: clamp(0.75rem, 2vw, 1rem);
            flex-wrap: wrap;
            margin-top: auto;
            /* Pushes navigation to the bottom of #test-container */
            padding: 1rem 0;
            /* Adjusted padding as it's sticky now */
            border-top: 1px solid var(--neutral-200);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            border-radius: var(--radius-lg);
            position: sticky;
            /* Make it stick to the bottom */
            bottom: 0;
            z-index: 10;
            /* Ensure it's above other content */
            width: 100%;
            /* Ensure it spans the full width of its container */
            left: 0;
            /* For sticky positioning */
            right: 0;
            /* For sticky positioning */
            padding-left: clamp(1.5rem, 4vw, 3rem);
            /* Match content-wrapper padding */
            padding-right: clamp(1.5rem, 4vw, 3rem);
            /* Match content-wrapper padding */
        }

        .progress-section {
            padding: 1rem 0;
            text-align: center;
            background: var(--neutral-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--neutral-200);
            margin-top: 1rem;
            position: sticky;
            /* Make it stick */
            bottom: calc(0px + 1rem + 2.5rem);
            /* Adjust calculation: 0 (bottom of navigation) + margin-top of nav + height of nav. APPROXIMATE: 0 (bottom of next element) + gap + avg button height. You'll need to measure actual nav height for perfect alignment. */
            z-index: 9;
            /* Below navigation but above other content */
            width: 100%;
            /* Ensure it spans the full width */
            left: 0;
            /* For sticky positioning */
            right: 0;
            /* For sticky positioning */
            padding-left: clamp(1.5rem, 4vw, 3rem);
            /* Match content-wrapper padding */
            padding-right: clamp(1.5rem, 4vw, 3rem);
            /* Match content-wrapper padding */
            box-shadow: var(--shadow-sm);
            /* Add a subtle shadow to distinguish */
        }

        #submit-btn {
            background: linear-gradient(135deg, var(--success), #10b981);
        }

        #submit-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #047857, var(--success));
        }

        /* Results section improvements */
        #results {
            animation: resultsAppear 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes resultsAppear {
            from {
                opacity: 0;
                transform: translateY(1rem);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #results table {
            width: 100%;
            border-collapse: collapse;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            background: white;
        }

        #results th,
        #results td {
            padding: clamp(0.75rem, 2vw, 1rem);
            text-align: center;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }

        #results th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #results tr:nth-child(even) {
            background: var(--neutral-50);
        }

        /* #results tr:hover {
            background: var(--primary-lightest);
            transition: var(--transition);
        } */

        tr.correct td:last-child {
            color: var(--success);
            font-weight: 600;
        }

        tr.incorrect td:last-child {
            color: var(--error);
            font-weight: 600;
        }

        #diagnosis {
            margin: 2rem 0;
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            font-weight: 600;
            color: rgb(63, 73, 127);
            text-align: center;
            padding: clamp(1rem, 3vw, 1.5rem);
            background: var(--primary-lightest);
            border-radius: var(--radius-xl);
            border-left: 0.25rem solid var(--primary);
            box-shadow: var(--shadow-md);
        }

        /* Deficiency info cards */
        #deficiency-info {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 18rem), 1fr));
            gap: 1.5rem;
        }

        .deficiency-type {
            background: white;
            border-radius: var(--radius-xl);
            padding: clamp(1.25rem, 3vw, 1.5rem);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            transition: var(--transition-slow);
            position: relative;
            overflow: hidden;
        }

        .deficiency-type::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0.25rem;
            height: 100%;
            background: #4CAF50;
            transition: var(--transition);
        }

        .deficiency-type:hover {
            transform: translateY(-0.25rem);
            box-shadow: var(--shadow-xl);
        }

        #protanopia::before {
            background: #f43f5e;
        }

        #deuteranopia::before {
            background: #10b981;
        }

        #general::before {
            background: #f59e0b;
        }

        .deficiency-type h4 {
            margin-bottom: 0.75rem;
            color: var(--neutral-800);
            font-size: clamp(1rem, 2.5vw, 1.125rem);
            font-weight: 600;
        }

        .deficiency-type p {
            color: rgb(182, 176, 176);
            line-height: 1.6;
            font-size: clamp(0.875rem, 2vw, 0.95rem);
        }

        /* Severity levels */
        .severity-levels {
            margin: 2rem 0;
            display: flex;
            justify-content: center;
            gap: clamp(0.75rem, 2vw, 1rem);
            flex-wrap: wrap;
        }

        .severity-level {
            cursor: default;
            border-radius: var(--radius-2xl);
            padding: clamp(0.5rem, 2vw, 0.75rem) clamp(1rem, 3vw, 1.5rem);
            border: 2px solid var(--primary);
            font-weight: 500;
            color: var(--primary);
            background: white;
            transition: var(--transition-slow);
            box-shadow: var(--shadow-sm);
            font-size: clamp(0.875rem, 2vw, 0.95rem);
        }

        .severity-level:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .severity-level.selected {
            color: white;
            background: var(--primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        /* Progress bar improvements */
        #progress-text {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-size: clamp(0.875rem, 2vw, 1rem);
        }

        .progress-container {
            background: var(--neutral-200);
            border-radius: var(--radius-2xl);
            height: 0.5rem;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        #progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            width: 0%;
            border-radius: var(--radius-2xl);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Action buttons section */
        .action-buttons {
            display: grid;
            grid-template-columns: rrepeat(3, 1fr);
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--neutral-200);
            justify-items: center;
        }

        .action-buttons button {
            width: 100%;
            justify-content: center;
        }

        .home-btn {
            grid-column: 2;
            /* puts it in the center column */
            grid-row: 2;
            /* puts it in the next row */
        }

        .btn-secondary {
            background: var(--neutral-600);
            align-items: center;
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--neutral-700);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover:not(:disabled) {
            background: #b45309;
        }

        /* Enhanced mobile responsiveness */
        @media (max-width: 768px) {
            .content-wrapper {
                padding: clamp(1rem, 3vw, 1.5rem);
            }

            .navigation {
                flex-direction: column;
                align-items: center;
                /* Re-adjust bottom for mobile if sticky */
                padding-left: clamp(1rem, 3vw, 1.5rem);
                padding-right: clamp(1rem, 3vw, 1.5rem);
            }

            .navigation button {
                width: 100%;
                max-width: 20rem;
            }

            .progress-section {
                /* Re-adjust bottom for mobile if sticky */
                padding-left: clamp(1rem, 3vw, 1.5rem);
                padding-right: clamp(1rem, 3vw, 1.5rem);
            }

            .severity-levels {
                flex-direction: column;
                align-items: center;
            }

            .severity-level {
                width: 100%;
                max-width: 16rem;
                text-align: center;
            }

            #deficiency-info {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            main {
                margin: 0.5rem;
                border-radius: var(--radius-xl);
            }

            .plate-image {
                max-width: 100%;
            }

            #results table {
                font-size: 0.75rem;
            }

            #results th,
            #results td {
                padding: 0.5rem 0.25rem;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --neutral-50: #0f172a;
                --neutral-100: #1e293b;
                --neutral-200: #334155;
                --neutral-800: #f1f5f9;
                --neutral-900: #ffffff;
            }

            body {
                /* background: linear-gradient(135deg, #1e293b 0%, #334155 100%); */
                background: #0b657c;
            }

            main {
                background-color: #113b4b;
                border-color: rgba(255, 255, 255, 0.1);
            }

            .test-plate,
            .input-container,
            .deficiency-type,
            #results table {
                background: #18485a;
                border-color: var(--neutral-200);
            }

            .plate-image-placeholder {
                background: var(--neutral-200);
            }

            /* Dark mode for sticky elements */
            .navigation {
                background: #18485a;
            }

            .progress-section {
                background: var(--neutral-100);
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for better accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Loading state */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <img src="https://eyesphere.in/wp-content/uploads/2024/05/logo-with-tagline-07.png" alt="Eyesphere Logo">
        </div>
        <div class="nav-links">
            <a href="#">Home</a>
            <a href="#">Services</a>
            <a href="#">About Us</a>
            <a href="#">Testimonials</a>
            <a href="#">Contact</a>
        </div>
        <div class="hamburger">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>
    </nav>
    <main>
        <div class="content-wrapper">
            <h1>🎨 Color Vision Assessment</h1>
            <div class="instructions" id="instructions">
                <p>Welcome to our comprehensive color vision test! This assessment uses 38 specialized plates to
                    evaluate your color perception. Take your time with each plate and identify the numbers or patterns
                    you can see clearly.</p>
            </div>

            <div id="start-section" style="text-align: center;">
                <button id="start-test">✨ Begin Assessment</button>
            </div>

            <div id="test-container" class="hidden">
                <div class="plates-wrapper">
                    <div class="test-plate active" id="plate-1">
                        <h3>Assessment Plate 1</h3>
                        <div class="plate-image-placeholder">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300' viewBox='0 0 300 300'%3E%3Cdefs%3E%3Cpattern id='dots' x='0' y='0' width='20' height='20' patternUnits='userSpaceOnUse'%3E%3Ccircle cx='10' cy='10' r='8' fill='%23dc2626'/%3E%3C/pattern%3E%3Cpattern id='dots2' x='0' y='0' width='20' height='20' patternUnits='userSpaceOnUse'%3E%3Ccircle cx='10' cy='10' r='8' fill='%2316a34a'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='300' height='300' fill='url(%23dots)'/%3E%3Ctext x='150' y='180' font-family='Arial, sans-serif' font-size='120' font-weight='bold' text-anchor='middle' fill='url(%23dots2)'%3E12%3C/text%3E%3C/svg%3E"
                                alt="Color Blindness Test Plate 1" class="plate-image" />
                        </div>
                        <div class="input-container">
                            <label for="answer-1">What number do you see in this pattern?</label>
                            <input type="number" id="answer-1" min="0" max="99"
                                placeholder="Enter the number you see" />
                        </div>
                    </div>
                    <!-- Other plates will be dynamically created here -->
                </div>

                <!-- Single navigation section for all plates -->
                <div class="navigation">
                    <button id="prev-btn" disabled>← Previous</button>
                    <button id="next-btn">Next →</button>
                    <button id="submit-btn" class="hidden">🔍 Analyze Results</button>
                </div>

                <div class="progress-section">
                    <div id="progress-text" aria-live="polite">Plate 1 of 38</div>
                    <div class="progress-container">
                        <div id="progress-fill" style="width: 2.6%;"></div>
                    </div>
                </div>
            </div>

            <div id="results" style="display:none;">
                <h2>📊 Your Assessment Results</h2>
                <table aria-label="Detailed test results">
                    <thead>
                        <tr>
                            <th>Plate</th>
                            <th>Your Response</th>
                            <th>Expected</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody id="results-body"></tbody>
                </table>

                <div id="diagnosis" role="region" aria-live="polite">
                    Your color vision assessment is complete!
                </div>

                <div class="severity-levels" aria-label="Assessment Severity Levels">
                    <div id="severity-none" class="severity-level">Normal</div>
                    <div id="severity-weak" class="severity-level">Mild</div>
                    <div id="severity-moderate" class="severity-level">Moderate</div>
                    <div id="severity-strong" class="severity-level">Strong</div>
                </div>

                <div id="deficiency-info" aria-label="Color Vision Information">
                    <div class="deficiency-type" id="protanopia">
                        <h4>🔴 Protanopia / Protanomaly</h4>
                        <p>Reduced sensitivity to red wavelengths. May experience difficulty distinguishing between red
                            and green hues, particularly in low light conditions.</p>
                    </div>
                    <div class="deficiency-type" id="deuteranopia">
                        <h4>🟢 Deuteranopia / Deuteranomaly</h4>
                        <p>Reduced sensitivity to green wavelengths. Most common form of color vision difference,
                            affecting red-green discrimination.</p>
                    </div>
                    <div class="deficiency-type" id="general">
                        <h4>🌈 General Red-Green Variation</h4>
                        <p>Some characteristics of red-green color vision differences detected, but not fitting a
                            specific category.</p>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="saveResultBtn">💾 Save Results</button>
                    <button class="btn-secondary">👤 View Profile</button>
                    <button class="btn-warning">➡️ Next Test</button>
                    <button class="btn-secondary">🏠 Home</button>
                </div>

                <div id="saveStatus" style="margin-top: 1rem; text-align: center;"></div>

                <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd;">
                    <button id="restart-btn">🔄 Retake Assessment</button>
                </div>
            </div>
        </div>
    </main>
</body>

</html>

<script>
    const staticUrl = "{% static '' %}";

    document.addEventListener('DOMContentLoaded', function () {
        const hamburger = document.querySelector('.hamburger');
        const navLinks = document.querySelector('.nav-links');

        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('open');
            navLinks.classList.toggle('open');
        });

        // Optional: Close menu when a link is clicked (for single-page apps)
        navLinks.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                hamburger.classList.remove('open');
                navLinks.classList.remove('open');
            });
        });
    });
</script>



<script>
    let normalCorrect = 0;
    let redGreenErrors = 0;
    let protanopiaIndicators = 0;
    let deuteranopiaIndicators = 0;
    let resultsHTML = ''; // This global variable is used to build the results table.

    document.addEventListener('DOMContentLoaded', function () {
        const testData = [
            // Plate 1: Normal and Red-Green Deficient see 12
            { plateNumber: 1, normalView: 12, redGreenDeficiency: 12, type: 'number' },
            // Plates 2-7: Normal sees one number, Red-Green Deficient sees another
            { plateNumber: 2, normalView: 8, redGreenDeficiency: 3, type: 'number' },
            { plateNumber: 3, normalView: 6, redGreenDeficiency: 5, type: 'number' },
            { plateNumber: 4, normalView: 29, redGreenDeficiency: 70, type: 'number' },
            { plateNumber: 5, normalView: 57, redGreenDeficiency: 35, type: 'number' },
            { plateNumber: 6, normalView: 5, redGreenDeficiency: 2, type: 'number' },
            { plateNumber: 7, normalView: 3, redGreenDeficiency: 5, type: 'number' },
            // Plates 8-17: Normal sees number, Red-Green Deficient sees nothing or a different number (null for nothing)
            { plateNumber: 8, normalView: 15, redGreenDeficiency: null, type: 'number' },
            { plateNumber: 9, normalView: 74, redGreenDeficiency: 21, type: 'number' }, // R-G sees 21
            { plateNumber: 10, normalView: 2, redGreenDeficiency: null, type: 'number' },
            { plateNumber: 11, normalView: 6, redGreenDeficiency: null, type: 'number' },
            { plateNumber: 12, normalView: 97, redGreenDeficiency: null, type: 'number' },
            { plateNumber: 13, normalView: 45, redGreenDeficiency: null, type: 'number' },
            { plateNumber: 14, normalView: 5, redGreenDeficiency: null, type: 'number' },
            { plateNumber: 15, normalView: 7, redGreenDeficiency: null, type: 'number' },
            { plateNumber: 16, normalView: 16, redGreenDeficiency: null, type: 'number' },
            { plateNumber: 17, normalView: 73, redGreenDeficiency: null, type: 'number' },
            // Plates 18-21: Normal sees nothing, Red-Green Deficient sees a number
            { plateNumber: 18, normalView: null, redGreenDeficiency: 5, type: 'number' },
            { plateNumber: 19, normalView: null, redGreenDeficiency: 2, type: 'number' },
            { plateNumber: 20, normalView: null, redGreenDeficiency: 45, type: 'number' },
            { plateNumber: 21, normalView: null, redGreenDeficiency: 73, type: 'number' },
            // Plates 22-25: Diagnostic plates for Protanopia (sees Protan number) vs. Deuteranopia (sees Deutan number)
            { plateNumber: 22, normalView: 26, protanopia: 6, deuteranopia: 2, type: 'number' },
            { plateNumber: 23, normalView: 42, protanopia: 2, deuteranopia: 4, type: 'number' },
            { plateNumber: 24, normalView: 35, protanopia: 5, deuteranopia: 3, type: 'number' },
            { plateNumber: 25, normalView: 96, protanopia: 6, deuteranopia: 9, type: 'number' },
            // Plates 26-27: Tracing lines for Protanopia vs. Deuteranopia
            { plateNumber: 26, normalView: 'both', protanopia: 'purple', deuteranopia: 'red', type: 'line' }, // 3: Both, 1: Purple, 2: Red
            { plateNumber: 27, normalView: 'both', protanopia: 'purple', deuteranopia: 'red', type: 'line' }, // 3: Both, 1: Purple, 2: Red
            // Plates 28-29: Normal sees nothing, Red-Green Deficient sees a line
            { plateNumber: 28, normalView: 'none', redGreenDeficiency: 'line', type: 'line' }, // 0: None, 1: Line
            { plateNumber: 29, normalView: 'none', redGreenDeficiency: 'line', type: 'line' }, // 0: None, 1: Line
            // Plates 30-33: Normal sees a line, Red-Green Deficient sees nothing
            { plateNumber: 30, normalView: 'line', redGreenDeficiency: 'none', type: 'line' }, // 1: Line, 0: None
            { plateNumber: 31, normalView: 'line', redGreenDeficiency: 'none', type: 'line' }, // 1: Line, 0: None
            { plateNumber: 32, normalView: 'line', redGreenDeficiency: 'none', type: 'line' }, // 1: Line, 0: None
            { plateNumber: 33, normalView: 'line', redGreenDeficiency: 'none', type: 'line' }, // 1: Line, 0: None
            // Plates 34-37: Color discrimination plates with specific line colors for normal vs. deficient vision
            { plateNumber: 34, normalView: 'blue-green-yellow', redGreenDeficiency: 'red-violet', type: 'line' }, // 1: Blue-green/Yellow-green, 2: Red-green/Violet
            { plateNumber: 35, normalView: 'blue-green-yellow', redGreenDeficiency: 'blue-violet', type: 'line' }, // 1: Blue-green/Yellow-green, 2: Blue-green/Violet
            { plateNumber: 36, normalView: 'violet-orange', redGreenDeficiency: 'blue-violet', type: 'line' }, // 1: Violet/Orange, 2: Blue-green/Violet
            { plateNumber: 37, normalView: 'violet-orange', redGreenDeficiency: 'blue-violet', type: 'line' }, // 1: Violet/Orange, 2: Blue-green/Violet
            // Plate 38: Everyone sees a line (control plate)
            { plateNumber: 38, normalView: 'line', redGreenDeficiency: 'line', type: 'line' } // 1: Line, 0: None (should always be 1)
        ];

        const startTestBtn = document.getElementById('start-test');
        const testContainer = document.getElementById('test-container');
        const instructionsDiv = document.getElementById('instructions');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const resultsDiv = document.getElementById('results');
        const diagnosisDiv = document.getElementById('diagnosis');
        const progressText = document.getElementById('progress-text');
        const progressFill = document.getElementById('progress-fill');
        const resultsTableBody = document.getElementById('results-body');
        const restartBtn = document.getElementById('restart-btn');
        const deficiencyInfoDiv = document.getElementById('deficiency-info');
        const deficiencyTypes = deficiencyInfoDiv.querySelectorAll('.deficiency-type');
        const startSection = document.getElementById('start-section'); // Added this for reset functionality

        let currentPlate = 1;
        const userAnswers = {};
        const totalPlates = testData.length; // Use testData.length for total plates

        // Dynamically create all plates (assuming plate 1 is NOT already in HTML)
        // If plate 1 is hardcoded in HTML, adjust this loop to start from 2.
        // Based on your original code, it seems plate 1 *is* treated separately initially,
        // so I'll keep the loop starting from 2 and assume plate 1 is in the HTML already.
        // If you want ALL plates created by JS, change the loop to start from 1.
        for (let i = 2; i <= 25; i++) {
            createNumberPlate(i);
        }
        for (let i = 26; i <= 38; i++) {
            createLinePlate(i);
        }

        function createNumberPlate(plateNumber) {
            const plateDiv = document.createElement('div');
            plateDiv.classList.add('test-plate');
            plateDiv.id = `plate-${plateNumber}`;

            // Remove navigation buttons from individual plates
            plateDiv.innerHTML = `
        <h3>Plate ${plateNumber}</h3>
        <div class="plate-image-placeholder">
            <img data-src="${staticUrl}plate${plateNumber}.png"
                 alt="Color Blindness Test Plate ${plateNumber}" class="plate-image" />
        </div>
        <div class="input-container">
            <label for="answer-${plateNumber}">What number do you see?</label>
            <input type="number" id="answer-${plateNumber}" min="0" max="99" placeholder="Enter number" />
        </div>
    `;

            // Append to plates wrapper, not test container
            document.querySelector('.plates-wrapper').appendChild(plateDiv);
        }

        function createLinePlate(plateNumber) {
            const plateDiv = document.createElement('div');
            plateDiv.classList.add('test-plate');
            plateDiv.id = `plate-${plateNumber}`;

            let options = '';

            // Generate options based on plate number
            if (plateNumber >= 26 && plateNumber <= 27) {
                options = `
            <option value="" selected disabled>Select an answer</option>
            <option value="0">No lines visible</option>
            <option value="1">Purple line only</option>
            <option value="2">Red line only</option>
            <option value="3">Both purple and red lines</option>
        `;
            } else if (plateNumber >= 28 && plateNumber <= 29) {
                options = `
            <option value="" selected disabled>Select an answer</option>
            <option value="0">No lines visible</option>
            <option value="1">Line visible</option>
        `;
            } else if (plateNumber >= 30 && plateNumber <= 33) {
                options = `
            <option value="" selected disabled>Select an answer</option>
            <option value="0">No lines visible</option>
            <option value="1">Line visible</option>
        `;
            } else if (plateNumber === 34) {
                options = `
            <option value="" selected disabled>Select an answer</option>
            <option value="0">No lines visible</option>
            <option value="1">Blue-green and yellow-green lines</option>
            <option value="2">Red-green and violet lines</option>
        `;
            } else if (plateNumber === 35) {
                options = `
            <option value="" selected disabled>Select an answer</option>
            <option value="0">No lines visible</option>
            <option value="1">Blue-green and yellow-green lines</option>
            <option value="2">Blue-green and violet lines</option>
        `;
            } else if (plateNumber >= 36 && plateNumber <= 37) {
                options = `
            <option value="" selected disabled>Select an answer</option>
            <option value="0">No lines visible</option>
            <option value="1">Violet and orange lines</option>
            <option value="2">Blue-green and violet lines</option>
        `;
            } else if (plateNumber === 38) {
                options = `
            <option value="" selected disabled>Select an answer</option>
            <option value="0">No lines visible</option>
            <option value="1">Line visible</option>
        `;
            }

            // Remove navigation buttons from individual plates
            plateDiv.innerHTML = `
        <h3>Plate ${plateNumber}</h3>
        <div class="plate-image-placeholder">
            <img data-src="${staticUrl}plate${plateNumber}.png"
                 alt="Color Blindness Test Plate ${plateNumber}" class="plate-image" />
        </div>
        <div class="input-container">
            <label for="answer-${plateNumber}">What lines do you see?</label>
            <select id="answer-${plateNumber}">
                ${options}
            </select>
        </div>
    `;

            // Append to plates wrapper, not test container
            document.querySelector('.plates-wrapper').appendChild(plateDiv);
        }

        function loadImageForPlate(plateNumber) {
            const plateDiv = document.getElementById(`plate-${plateNumber}`);
            if (!plateDiv) return;
            const img = plateDiv.querySelector('img.plate-image');
            if (!img) return;
            // Only load if src is not already set or is a placeholder
            if (!img.src || img.src === window.location.href || img.src.endsWith('/') || img.src.includes('data:image/gif;base64')) {
                const src = img.getAttribute('data-src');
                if (src) img.src = src;
            }
        }

        function showPlate(plateNumber) {
            if (plateNumber < 1 || plateNumber > totalPlates) return;

            const oldPlateDiv = document.getElementById(`plate-${currentPlate}`);
            if (oldPlateDiv) oldPlateDiv.classList.remove('active');

            currentPlate = plateNumber;

            const newPlateDiv = document.getElementById(`plate-${currentPlate}`);
            if (newPlateDiv) newPlateDiv.classList.add('active');

            prevBtn.disabled = (currentPlate === 1);

            if (currentPlate === totalPlates) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }

            updateProgress();
            // Load images for current, previous, and next plates for smoother UX
            loadImageForPlate(currentPlate);
            if (currentPlate > 1) loadImageForPlate(currentPlate - 1);
            if (currentPlate < totalPlates) loadImageForPlate(currentPlate + 1);
        }

        function updateProgress() {
            progressText.textContent = `Plate ${currentPlate} of ${totalPlates}`;
            progressFill.style.width = `${(currentPlate / totalPlates) * 100}%`;
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const trimmed = cookie.trim();
                    if (trimmed.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function resetTest() {
            currentPlate = 1;
            // Reset all global counters and stored answers
            normalCorrect = 0;
            redGreenErrors = 0;
            protanopiaIndicators = 0;
            deuteranopiaIndicators = 0;
            resultsHTML = '';
            Object.keys(userAnswers).forEach(key => delete userAnswers[key]);

            // Clear input/select values on all plates
            for (let i = 1; i <= totalPlates; i++) {
                if (i <= 25) { // Number plates
                    const input = document.getElementById(`answer-${i}`);
                    if (input) input.value = '';
                } else { // Line plates
                    const select = document.getElementById(`answer-${i}`);
                    if (select) select.value = ''; // Set to empty string to select the "Select an answer" disabled option
                }
            }

            // Hide all plates, then show the first one and reset navigation buttons
            document.querySelectorAll('.test-plate').forEach(plate => plate.classList.remove('active'));
            const plate1Div = document.getElementById('plate-1');
            if (plate1Div) plate1Div.classList.add('active');

            prevBtn.disabled = true;
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');

            // Show initial instructions and start button, hide test and results
            resultsDiv.style.display = 'none';
            testContainer.classList.add('hidden');
            instructionsDiv.classList.remove('hidden');
            startSection.classList.remove('hidden'); // Ensure the start section is visible
            startTestBtn.classList.remove('hidden');

            updateProgress();

            // Clear diagnosis and deficiency highlights
            diagnosisDiv.innerHTML = '';
            document.querySelectorAll('.severity-level').forEach(el => el.classList.remove('selected'));
            deficiencyTypes.forEach(type => type.style.borderLeft = '4px solid #4CAF50'); // Reset to normal color
        }

        function saveCurrentAnswer() {
            let answerValue;
            if (currentPlate <= 25) { // Number plates
                const inputElem = document.getElementById(`answer-${currentPlate}`);
                if (inputElem) {
                    answerValue = inputElem.value;
                    userAnswers[currentPlate] = answerValue !== '' ? parseInt(answerValue) : null;
                }
            } else { // Line plates
                const selectElem = document.getElementById(`answer-${currentPlate}`);
                if (selectElem) {
                    answerValue = selectElem.value;
                    userAnswers[currentPlate] = answerValue !== '' ? parseInt(answerValue) : null; // Select values are parsed as int
                }
            }
        }

        function calculateResults() {
            // Reset counters *before* calculation each time results are generated
            normalCorrect = 0;
            redGreenErrors = 0;
            protanopiaIndicators = 0;
            deuteranopiaIndicators = 0;
            resultsHTML = ''; // Clear previous results HTML

            for (let i = 1; i <= totalPlates; i++) {
                const plate = testData[i - 1]; // testData is 0-indexed, plate numbers are 1-indexed
                const userAnswer = userAnswers[i] ?? null; // Use nullish coalescing for safety
                let resultClass = 'incorrect'; // Renamed to avoid conflict with 'result' variable
                let expectedForDisplay = '';
                let userAnswerText = userAnswer !== null ? String(userAnswer) : 'No answer'; // Default for numbers, will be overridden for lines

                if (plate.type === 'number') {
                    // Determine expected text for number plates
                    if (i === 1) { // Plate 1: Everyone sees 12
                        expectedForDisplay = `${plate.normalView} (Everyone)`;
                    } else if (i >= 2 && i <= 7) { // Plates 2-7: Normal vs. Red-Green Deficient
                        expectedForDisplay = `${plate.normalView} (Normal), ${plate.redGreenDeficiency} (Red-Green Deficiency)`;
                    } else if (i >= 8 && i <= 17) { // Plates 8-17: Normal sees number, R-G deficient sees null/different
                        expectedForDisplay = `${plate.normalView} (Normal), ${plate.redGreenDeficiency !== null ? plate.redGreenDeficiency + ' (Red-Green Deficiency)' : 'No number (Red-Green Deficiency)'}`;
                    } else if (i >= 18 && i <= 21) { // Plates 18-21: Normal sees null/nothing, R-G deficient sees number
                        expectedForDisplay = `${plate.normalView !== null ? plate.normalView + ' (Normal)' : 'No number (Normal)'}, ${plate.redGreenDeficiency} (Red-Green Deficiency)`;
                    } else if (i >= 22 && i <= 25) { // Plates 22-25: Protanopia vs. Deuteranopia
                        expectedForDisplay = `${plate.normalView} (Normal), ${plate.protanopia} (Protanopia), ${plate.deuteranopia} (Deuteranopia)`;
                    }

                    // Check correctness for number plates
                    if (userAnswer === plate.normalView) {
                        normalCorrect++;
                        resultClass = 'correct';
                    } else if ((i >= 2 && i <= 7) || (i >= 9 && i <= 17 && plate.redGreenDeficiency !== null) || (i >= 22 && i <= 25)) {
                        // For plates where R-G deficient see a *specific* number, check if user's answer matches that.
                        if (userAnswer === plate.redGreenDeficiency) {
                            redGreenErrors++;
                        }
                        if (i >= 22 && i <= 25) { // Specific protan/deutan indicators
                            if (userAnswer === plate.protanopia) protanopiaIndicators++;
                            if (userAnswer === plate.deuteranopia) deuteranopiaIndicators++;
                        }
                    } else if (i >= 8 && i <= 17 && plate.redGreenDeficiency === null) {
                        // For plates where R-G deficient see nothing (null)
                        if (userAnswer === null || userAnswer === 0) { // If normal sees a number but user saw nothing
                            redGreenErrors++;
                        }
                    } else if (i >= 18 && i <= 21) {
                        // For plates where Normal sees nothing (null) but R-G deficient sees a number
                        if (userAnswer === plate.redGreenDeficiency) { // If user saw a number, it's an R-G error (for normal vision assessment)
                            redGreenErrors++;
                        }
                    }

                } else { // Line plates
                    // Get the user's selected text for display purposes
                    const selectElem = document.getElementById(`answer-${i}`);
                    if (selectElem && selectElem.options[selectElem.value]) {
                        userAnswerText = selectElem.options[selectElem.value].text;
                    } else {
                        userAnswerText = 'No answer'; // If no selection was made or invalid value
                    }

                    if (i >= 26 && i <= 27) {
                        expectedForDisplay = 'Both purple and red lines (Normal), Purple line only (Protanopia), Red line only (Deuteranopia)';
                        if (userAnswer === 3) { normalCorrect++; resultClass = 'correct'; }
                        else if (userAnswer === 1) { protanopiaIndicators++; redGreenErrors++; }
                        else if (userAnswer === 2) { deuteranopiaIndicators++; redGreenErrors++; }
                    } else if (i >= 28 && i <= 29) {
                        expectedForDisplay = 'No lines visible (Normal), Line visible (Red-Green Deficiency)';
                        if (userAnswer === 0) { normalCorrect++; resultClass = 'correct'; }
                        else if (userAnswer === 1) { redGreenErrors++; }
                    } else if (i >= 30 && i <= 33) {
                        expectedForDisplay = 'Line visible (Normal), No lines visible (Red-Green Deficiency)';
                        if (userAnswer === 1) { normalCorrect++; resultClass = 'correct'; }
                        else if (userAnswer === 0) { redGreenErrors++; }
                    } else if (i === 34) {
                        expectedForDisplay = 'Blue-green and yellow-green lines (Normal), Red-green and violet lines (Red-Green Deficiency)';
                        if (userAnswer === 1) { normalCorrect++; resultClass = 'correct'; }
                        else if (userAnswer === 2) { redGreenErrors++; }
                    } else if (i === 35) {
                        expectedForDisplay = 'Blue-green and yellow-green lines (Normal), Blue-green and violet lines (Red-Green Deficiency)';
                        if (userAnswer === 1) { normalCorrect++; resultClass = 'correct'; }
                        else if (userAnswer === 2) { redGreenErrors++; }
                    } else if (i >= 36 && i <= 37) {
                        expectedForDisplay = 'Violet and orange lines (Normal), Blue-green and violet lines (Red-Green Deficiency)';
                        if (userAnswer === 1) { normalCorrect++; resultClass = 'correct'; }
                        else if (userAnswer === 2) { redGreenErrors++; }
                    } else if (i === 38) { // Control plate, everyone should see line
                        expectedForDisplay = 'Line visible (Everyone)';
                        if (userAnswer === 1) { normalCorrect++; resultClass = 'correct'; }
                        // If user answers 0 (no lines), it's still incorrect but doesn't necessarily indicate R-G deficiency.
                    }
                }

                resultsHTML += `
                <tr class="${resultClass}">
                    <td>${i}</td>
                    <td>${userAnswerText}</td>
                    <td>${expectedForDisplay}</td>
                    <td class="${resultClass}">${resultClass}</td>
                </tr>`;
            }

            resultsTableBody.innerHTML = resultsHTML;
            determineDiagnosis(normalCorrect, redGreenErrors, protanopiaIndicators, deuteranopiaIndicators);
            showDeficiencyInfo(redGreenErrors, protanopiaIndicators, deuteranopiaIndicators);
        }

        function determineDiagnosis(normalCorrect, redGreenErrors, protanopiaIndicators, deuteranopiaIndicators) {
            let diagnosis = '';
            let severity = 'none';

            // Consider the first 21 plates for a strong indication of red-green deficiency
            // and plates 22-25 (and 26-27 for lines) for protan/deutan differentiation.
            const totalDiagnosticNumberPlates = 21; // Plates 2-21
            const totalDifferentialPlates = 6; // Plates 22-25 (numbers) and 26-27 (lines)

            if (redGreenErrors <= 2) { // Very few errors, likely normal vision
                diagnosis = 'Your color vision appears to be **normal**.';
                severity = 'none';
            } else {
                diagnosis = 'You have some form of **red-green color blindness**.';

                // Determine severity based on total red-green errors
                if (redGreenErrors >= 15) severity = 'strong';
                else if (redGreenErrors >= 8) severity = 'moderate';
                else if (redGreenErrors >= 3) severity = 'weak';
                else severity = 'mild'; // For 1-2 redGreenErrors, can be mild.

                // Differentiate between Protanopia and Deuteranopia if indicators are present
                if (protanopiaIndicators > 0 && protanopiaIndicators > deuteranopiaIndicators) {
                    diagnosis += '<br><br>The results indicate **Protanopia or Protanomaly** (reduced sensitivity to red light).';
                } else if (deuteranopiaIndicators > 0 && deuteranopiaIndicators > protanopiaIndicators) {
                    diagnosis += '<br><br>The results indicate **Deuteranopia or Deuteranomaly** (reduced sensitivity to green light).';
                } else if (redGreenErrors > 0) {
                    // If there are R-G errors but no clear dominant type from differential plates
                    diagnosis += '<br><br>The specific type (Protan/Deutan) could not be precisely determined from the differential plates, but results show characteristics of red-green color vision deficiency.';
                }
            }

            diagnosisDiv.innerHTML = diagnosis;

            // Highlight the determined severity level
            document.querySelectorAll('.severity-level').forEach(el => el.classList.remove('selected'));
            const severityEl = document.getElementById(`severity-${severity}`);
            if (severityEl) severityEl.classList.add('selected');
        }

        function showDeficiencyInfo(redGreenErrors, protanopiaIndicators, deuteranopiaIndicators) {
            // Reset all deficiency types to normal green border
            deficiencyTypes.forEach(type => {
                type.style.borderLeft = '4px solid #4CAF50'; // Green for normal/no deficiency highlighted
            });

            if (redGreenErrors > 2) { // If there's evidence of red-green deficiency
                if (protanopiaIndicators > deuteranopiaIndicators && protanopiaIndicators > 0) {
                    document.getElementById('protanopia').style.borderLeft = '4px solid #f43f5e'; // Highlight Protanopia (reddish)
                } else if (deuteranopiaIndicators > protanopiaIndicators && deuteranopiaIndicators > 0) {
                    document.getElementById('deuteranopia').style.borderLeft = '4px solid #10b981'; // Highlight Deuteranopia (greenish)
                } else {
                    // If no clear protan/deutan dominance, but red-green errors exist
                    document.getElementById('general').style.borderLeft = '4px solid #f59e0b'; // Highlight general red-green (amber)
                }
            }
        }

        // --- Event Listeners ---
        startTestBtn.addEventListener('click', () => {
            instructionsDiv.classList.add('hidden');
            startTestBtn.classList.add('hidden');
            testContainer.classList.remove('hidden');
            updateProgress();
            showPlate(currentPlate);
        });

        prevBtn.addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentPlate > 1) {
                showPlate(currentPlate - 1);
            }
        });

        nextBtn.addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentPlate < totalPlates) {
                showPlate(currentPlate + 1);
            }
        });

        submitBtn.addEventListener('click', () => {
            saveCurrentAnswer(); // Save the answer for the last plate
            calculateResults(); // Calculate and display results
            testContainer.classList.add('hidden');
            resultsDiv.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top for results
        });

        document.getElementById('saveResultBtn').addEventListener('click', async () => {
            const diagnosisText = diagnosisDiv.innerText;
            const severityLevel = document.querySelector('.severity-level.selected')?.id?.replace('severity-', '') || 'none';

            const data = {
                normal_correct: normalCorrect,
                red_green_errors: redGreenErrors,
                protanopia_indicators: protanopiaIndicators,
                deuteranopia_indicators: deuteranopiaIndicators,
                severity_level: severityLevel,
                diagnosis_text: diagnosisText,
            };
            try {
                const baseUrl = window.location.hostname.includes('localhost') || window.location.hostname === '127.0.0.1'
                    ? 'http://127.0.0.1:8000'
                    : 'https://netrascreen.in';

                const response = await fetch(`${baseUrl}/api/color-vision-tests/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.getElementById('saveStatus').innerText = '✅ Results saved successfully!';
                } else {
                    // Attempt to get a more specific error message from the response body
                    const errorData = await response.json();
                    document.getElementById('saveStatus').innerText = '❌ Failed to save results: ' + (errorData.detail || JSON.stringify(errorData));
                }
            } catch (error) {
                document.getElementById('saveStatus').innerText = '❌ Error occurred: ' + error.message;
            }
        });

        restartBtn.addEventListener('click', resetTest);

        // Initial setup when the DOM is fully loaded
        // Assumes plate-1 is already in the HTML.
        const plate1Img = document.querySelector('#plate-1 img.plate-image');
        if (plate1Img) {
            // Ensure plate 1 image is loaded, if it's part of initial HTML
            plate1Img.dataset.src = "plate1.png"; // Set data-src for lazy loading
            plate1Img.src = "plate1.png"; // Immediately set src for plate 1
        }

        showPlate(currentPlate); // Display the first plate
        updateProgress(); // Update initial progress text
    });
</script>
</body>

</html>